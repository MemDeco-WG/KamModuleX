(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const y={MODULE_PATH:"/data/adb/modules//",DEBUG_LOG_PATH:"/data/adb//debug.log",isKSUEnvironment(){return typeof ksu<"u"&&ksu.toast},isDebugMode(){const a=localStorage.getItem("modulewebui-settings");return a&&JSON.parse(a).debugMode||!1},logDebug(a,e="INFO"){if(!this.isDebugMode())return;const n=`[${new Date().toISOString()}] [${e}] ${a}
`;this._execCommandInternal(`echo "${n}" >> ${this.DEBUG_LOG_PATH}`)},_isCommandError(a){return!a||typeof a!="string"?!1:[/error:/i,/failed/i,/not found/i,/permission denied/i,/no such file/i,/command not found/i,/ksu\.exec is not defined/i].some(t=>t.test(a))},_execCommandInternal(a,e){const t=`callback_${Date.now()}_${Math.floor(Math.random()*1e3)}`;if(window[t]=(n,i,o)=>{if(e){const s=i||o||"",r=n!==0||o&&o.trim()!=="";e(s,!r,{errno:n,stdout:i,stderr:o})}delete window[t]},typeof ksu<"u"&&ksu.exec)ksu.exec(a,JSON.stringify({}),t);else{const n="Error: ksu.exec is not defined.";console.error(n),e&&e(n,!1,{errno:-1,stdout:"",stderr:n})}},execCommand(a,e){this.isDebugMode()&&(this.logDebug(`Executing command: ${a}`,"EXEC"),this.showToast(`[DEBUG] Executing command: ${a}`,"info")),this._execCommandInternal(a,(t,n,i)=>{const o=!n||this._isCommandError(t);if(this.isDebugMode()){const s=o?"ERROR":"SUCCESS";this.logDebug(`Command output [${s}]: ${t}`,"OUTPUT"),i&&this.logDebug(`Command details - errno: ${i.errno}, stdout length: ${i.stdout?i.stdout.length:0}, stderr length: ${i.stderr?i.stderr.length:0}`,"OUTPUT"),this.showToast(`[DEBUG] Command ${s}: ${t.substring(0,100)}${t.length>100?"...":""}`,o?"error":"info")}e&&e(t,!o,i)})},exec(a,e={}){return new Promise((t,n)=>{const i=`callback_${Date.now()}_${Math.floor(Math.random()*1e3)}`;window[i]=(s,r,g)=>{t({errno:s,stdout:r,stderr:g}),o(i)};function o(s){delete window[s]}try{typeof ksu<"u"&&ksu.exec?ksu.exec(a,JSON.stringify(e),i):(n(new Error("ksu.exec is not defined")),o(i))}catch(s){n(s),o(i)}})},showError(a,e=""){let t=a;a.includes("ksu.exec is not defined")?t=window.i18n?window.i18n.t("errors.ksuNotDefined"):"KSU not defined":a.includes("not found")?t=window.i18n?window.i18n.t("errors.fileNotFound"):"File not found":a.includes("permission denied")?t=window.i18n?window.i18n.t("errors.permissionDenied"):"Permission denied":a.includes("failed")&&(t=window.i18n?window.i18n.t("errors.execFailed"):"Execution failed"),e&&(t=`${e}: ${t}`),this.showToast(t,"error"),this.isDebugMode()&&this.logDebug(`Error occurred [${e}]: ${a}`,"ERROR")},showToast(a,e="info"){this.isDebugMode()&&!a.includes("[DEBUG]")&&this.logDebug(`Toast display: [${e.toUpperCase()}] ${a}`,"TOAST");const t=window.settingsManager;if((t?t.getSetting("useNativeToast"):this.isKSUEnvironment())&&this.isKSUEnvironment()){ksu.toast(a);return}const i=document.getElementById("toast-container");if(!i){console.warn("Toast container not found."),this.isKSUEnvironment()?ksu.toast(a):console.log(a);return}const o=document.createElement("div");o.className=`toast toast-${e}`,o.textContent=a,i.appendChild(o),setTimeout(()=>{o.classList.add("show")},10),setTimeout(()=>{o.classList.remove("show"),o.classList.add("hide"),o.addEventListener("transitionend",()=>{o.remove()},{once:!0})},3e3)}};window.core=y;const E="modulepreload",L=function(a,e){return new URL(a,e).href},b={},w=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){let d=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const s=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),g=r?.nonce||r?.getAttribute("nonce");i=d(t.map(l=>{if(l=L(l,n),l in b)return;b[l]=!0;const c=l.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(!!n)for(let p=s.length-1;p>=0;p--){const f=s[p];if(f.href===l&&(!c||f.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${u}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":E,c||(h.as="script"),h.crossOrigin="",h.href=l,g&&h.setAttribute("nonce",g),document.head.appendChild(h),c)return new Promise((p,f)=>{h.addEventListener("load",p),h.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(s){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=s,window.dispatchEvent(r),!r.defaultPrevented)throw s}return i.then(s=>{for(const r of s||[])r.status==="rejected"&&o(r.reason);return e().catch(o)})};class M{constructor(){this.currentLanguage="zh",this.translations=new Map,this.fallbackLanguage="en";const e=localStorage.getItem("modulewebui-language");e&&["zh","en","ru"].includes(e)?this.currentLanguage=e:this.detectBrowserLanguage()}detectBrowserLanguage(){const e=navigator.language||navigator.userLanguage;e.startsWith("zh")?this.currentLanguage="zh":e.startsWith("ru")?this.currentLanguage="ru":this.currentLanguage="en"}async loadLanguage(e){if(this.translations.has(e))return!0;try{const n=(await w(()=>import(`../i18n/${e}.json`),[],import.meta.url)).default,i=await this.loadModuleTranslations(e),o=this.mergeTranslations(n,i);return this.translations.set(e,o),!0}catch(t){return console.error(`Error loading language ${e}:`,t),e!==this.fallbackLanguage?await this.loadLanguage(this.fallbackLanguage):!1}}async loadModuleTranslations(e){const t={};try{const n=await w(()=>import(`../i18n/modules/${e}.json`),[],import.meta.url);Object.assign(t,n.default),window.core&&window.core.isDebugMode()&&window.core.logDebug(`Loaded module translations for ${e}`,"I18N")}catch{window.core&&window.core.isDebugMode()&&window.core.logDebug(`No module translations found for ${e}`,"I18N")}return t}mergeTranslations(e,t){const n={...e};for(const[i,o]of Object.entries(t))typeof o=="object"&&o!==null&&!Array.isArray(o)?n[i]=this.mergeTranslations(n[i]||{},o):n[i]=o;return n}async init(){await this.loadLanguage(this.currentLanguage),this.currentLanguage!==this.fallbackLanguage&&await this.loadLanguage(this.fallbackLanguage),document.documentElement.lang=this.getLanguageCode()}t(e,t={}){const n=this.getTranslation(e,this.currentLanguage)||this.getTranslation(e,this.fallbackLanguage)||e;return this.interpolate(n,t)}getTranslation(e,t){const n=this.translations.get(t);if(!n)return null;const i=e.split(".");let o=n;for(const s of i)if(o&&typeof o=="object"&&s in o)o=o[s];else return null;return o}interpolate(e,t){return typeof e!="string"?e:e.replace(/\{\{(\w+)\}\}/g,(n,i)=>t[i]!==void 0?t[i]:n)}async setLanguage(e){return["zh","en","ru"].includes(e)?this.currentLanguage===e?!0:await this.loadLanguage(e)?(this.currentLanguage=e,localStorage.setItem("modulewebui-language",e),document.documentElement.lang=this.getLanguageCode(),window.dispatchEvent(new CustomEvent("languageChanged",{detail:{language:e}})),!0):(console.error(`Failed to load language: ${e}`),!1):(console.warn(`Unsupported language: ${e}`),!1)}getCurrentLanguage(){return this.currentLanguage}getLanguageCode(){return{zh:"zh-CN",en:"en-US",ru:"ru-RU"}[this.currentLanguage]||"en-US"}getSupportedLanguages(){return[{code:"zh",name:"中文",nativeName:"中文"},{code:"en",name:"English",nativeName:"English"},{code:"ru",name:"Russian",nativeName:"Русский"}]}formatNumber(e,t={}){const n=this.getLanguageCode();return new Intl.NumberFormat(n,t).format(e)}formatDate(e,t={}){const n=this.getLanguageCode();return new Intl.DateTimeFormat(n,t).format(e)}}const $=new M;window.i18n=$;class C{constructor(){this.confirmDialog=document.getElementById("confirm-dialog"),this.confirmTitle=document.getElementById("confirm-title"),this.confirmContent=document.getElementById("confirm-content"),this.confirmCancel=document.getElementById("confirm-cancel"),this.confirmOk=document.getElementById("confirm-ok"),this.dialogClickHandlers=new Map,this.setupEventListeners(),this.createDynamicDialogs(),this.addClickOutsideHandler(this.confirmDialog)}createDynamicDialogs(){this.createGenericDialog(),this.createInputDialog(),this.createListDialog(),this.createPopupDialog()}addClickOutsideHandler(e,t=!0){const n=i=>{if(i.target===e){const o=this.dialogClickHandlers.get(e);o&&o.closable&&this.closeDialogWithAnimation(e)}};e.addEventListener("click",n),this.dialogClickHandlers.set(e,{handler:n,closable:t})}setDialogClosable(e,t){const n=this.dialogClickHandlers.get(e);n&&(n.closable=t)}createDialog(e,t,n){const i=document.createElement("dialog");return i.id=e,i.className=t,i.innerHTML=n,document.body.appendChild(i),this.addClickOutsideHandler(i),i}show(e,t={}){const{closable:n=!0}=t;return this.setDialogClosable(e,n),this.showDialogWithAnimation(e),new Promise(i=>{e._resolve=i})}close(e,t=null){this.closeDialogWithAnimation(e),e._resolve&&(e._resolve(t),delete e._resolve)}createGenericDialog(){this.genericDialog=this.createDialog("generic-dialog","generic-dialog",`
            <div class="dialog-header">
                <h2 id="generic-title">标题</h2>
                <button id="generic-close" class="dialog-close-btn" style="display: flex;">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="dialog-content" id="generic-content">
                <!-- 动态内容 -->
            </div>
            <fieldset id="generic-actions">
                <!-- 动态按钮 -->
            </fieldset>
        `)}createInputDialog(){this.inputDialog=this.createDialog("input-dialog","dialog",`
            <div class="dialog-header">
                <h2 id="input-dialog-title"></h2>
            </div>
            <div class="dialog-content simple">
                <p id="input-dialog-message"></p>
                <input type="text" id="input-dialog-input" class="dialog-input" />
            </div>
            <div class="dialog-actions">
                <button id="input-dialog-cancel" class="text">取消</button>
                <button id="input-dialog-confirm" class="filled">确定</button>
            </div>
        `)}createListDialog(){this.listDialog=this.createDialog("list-dialog","dialog",`
            <div class="dialog-header">
                <h2 id="list-dialog-title"></h2>
            </div>
            <div class="dialog-content complex">
                <div id="list-dialog-list" class="dialog-list"></div>
            </div>
            <div class="dialog-actions">
                <button id="list-dialog-cancel" class="text">取消</button>
            </div>
        `)}createPopupDialog(){this.popupDialog=this.createDialog("popup-dialog","popup-dialog",`
            <div class="popup-content" id="popup-content">
                <!-- 动态内容 -->
            </div>
        `)}setupEventListeners(){typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&window.window.core.logDebug("DialogManager event listeners setup completed","DIALOG"),this.confirmCancel.addEventListener("click",()=>{typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&window.window.core.logDebug("User clicked cancel button","DIALOG"),this.closeDialogWithAnimation(this.confirmDialog)})}showDialogWithAnimation(e){typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&window.window.core.logDebug(`Start showing dialog animation: ${e.id}`,"DIALOG"),e.showModal(),setTimeout(()=>{e.classList.add("showing"),typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&window.window.core.logDebug(`Dialog show animation completed: ${e.id}`,"DIALOG")},10)}closeDialogWithAnimation(e){typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&window.window.core.logDebug(`Start closing dialog animation: ${e.id}`,"DIALOG"),e.classList.remove("showing"),e.classList.add("closing"),setTimeout(()=>{e.close(),e.classList.remove("closing"),typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&window.window.core.logDebug(`Dialog close animation completed: ${e.id}`,"DIALOG")},200)}showGeneric(e){return new Promise(t=>{const{title:n,content:i,buttons:o=[],closable:s=!0,isComplex:r=!1}=e,g=document.getElementById("generic-title");g&&(g.textContent=n);const d=document.getElementById("generic-content");d&&(d.innerHTML=i,d.className=`dialog-content ${r?"complex":"simple"}`);const l=document.getElementById("generic-close");l?s?(l.style.display="flex",l.onclick=()=>{this.closeDialogWithAnimation(this.genericDialog),t(null)}):l.style.display="none":window.core&&window.core.isDebugMode()&&window.core.logDebug("Generic close button not found","DIALOG");const c=document.getElementById("generic-actions");c?(c.innerHTML="",o.forEach((u,m)=>{const h=document.createElement("button");h.textContent=u.text,u.style&&(h.className=u.style),h.onclick=()=>{this.closeDialogWithAnimation(this.genericDialog),u.action&&u.action(),t(m)},c.appendChild(h)})):window.core&&window.core.isDebugMode()&&window.core.logDebug("Generic actions container not found","DIALOG"),this.showDialogWithAnimation(this.genericDialog)})}showInput(e,t,n="",i=""){return new Promise(o=>{document.getElementById("input-title").textContent=e,document.getElementById("input-message").textContent=t;const s=document.getElementById("input-field");s.placeholder=n,s.value=i;const r=document.getElementById("input-cancel"),g=document.getElementById("input-ok"),d=r.cloneNode(!0),l=g.cloneNode(!0);r.parentNode.replaceChild(d,r),g.parentNode.replaceChild(l,g),d.onclick=()=>{this.closeDialogWithAnimation(this.inputDialog),o(null)},l.onclick=()=>{const c=s.value.trim();this.closeDialogWithAnimation(this.inputDialog),o(c)},s.onkeydown=c=>{c.key==="Enter"&&l.click()},this.showDialogWithAnimation(this.inputDialog),setTimeout(()=>s.focus(),100)})}showList(e,t){return new Promise(n=>{document.getElementById("list-title").textContent=e;const i=document.getElementById("list-container");i.innerHTML="",t.forEach((r,g)=>{const d=document.createElement("div");d.className="dialog-list-item",d.innerHTML=`
                    ${r.icon?`<span class="material-symbols-rounded">${r.icon}</span>`:""}
                    <span>${r.text}</span>
                `,d.onclick=()=>{this.closeDialogWithAnimation(this.listDialog),n(r.value!==void 0?r.value:r.text)},i.appendChild(d)});const o=document.getElementById("list-cancel"),s=o.cloneNode(!0);o.parentNode.replaceChild(s,o),s.onclick=()=>{this.closeDialogWithAnimation(this.listDialog),n(null)},this.showDialogWithAnimation(this.listDialog)})}showConfirm(e,t){return typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&(window.window.core.logDebug("DIALOG",`Show confirmation dialog: ${e}`),window.window.core.showToast("[DEBUG] Showing confirm dialog","info")),new Promise(n=>{this.confirmTitle.textContent=e,this.confirmContent.textContent=t;const i=this.confirmOk.cloneNode(!0);this.confirmOk.parentNode.replaceChild(i,this.confirmOk),this.confirmOk=i,this.confirmOk.addEventListener("click",()=>{typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&window.window.core.logDebug("DIALOG","User clicked confirm"),this.closeDialogWithAnimation(this.confirmDialog),n(!0)});const o=()=>{typeof window.window.core<"u"&&window.window.core.isDebugMode&&window.window.core.isDebugMode()&&window.window.core.logDebug("DIALOG","Dialog closed, user cancelled"),this.confirmDialog.removeEventListener("close",o),n(!1)};this.confirmDialog.addEventListener("close",o),this.showDialogWithAnimation(this.confirmDialog)})}showPopup(e){const{content:t,closable:n=!0}=e,i=document.getElementById("popup-content");return i.innerHTML=t,this.show(this.popupDialog,{closable:n})}dialog={confirm:(e,t)=>this.showConfirm(e,t),input:(e,t,n="",i="")=>this.showInput(e,t,n,i),list:(e,t)=>this.showList(e,t),generic:e=>this.showGeneric(e),popup:e=>this.showPopup(e),close:(e,t)=>this.close(e,t)}}window.DialogManager=new C;class v{constructor(){this.plugins=new Map,this.hooks=new Map,this.pluginButtons={header:[],sidebar:[],bottom:[]},this.pluginPages=new Map,this.isInitialized=!1,window.core.isDebugMode()&&window.core.logDebug("PluginManager initialized","PLUGIN")}async init(){if(!this.isInitialized)try{await this.ensurePluginDirectories(),await this.loadInstalledPlugins(),this.isInitialized=!0,window.core.isDebugMode()&&window.core.logDebug("PluginManager initialization completed","PLUGIN")}catch(e){console.error("Failed to initialize PluginManager:",e)}}async ensurePluginDirectories(){window.core.isDebugMode()&&window.core.logDebug("Plugin directories ensured","PLUGIN")}async loadInstalledPlugins(){try{const e=await this.scanPluginConfigs();for(const t of e)try{await this.loadPluginFromConfig(t)}catch(n){window.core.isDebugMode()&&window.core.logDebug(`Failed to load plugin ${t.id}: ${n.message}`,"PLUGIN")}}catch{window.core.isDebugMode()&&window.core.logDebug("No plugins found or failed to scan plugins","PLUGIN")}}async scanPluginConfigs(){return[]}async loadPluginFromConfig(e){if(this.plugins.has(e.id)){window.core.isDebugMode()&&window.core.logDebug(`Plugin ${e.id} already loaded`,"PLUGIN");return}try{let t;if(e.type==="class"){const i=await w(()=>import(`../plugins/${e.id}/${e.entry||"index.js"}`),[],import.meta.url),o=i.default||i[e.className||e.id];if(!o)throw new Error(`Plugin ${e.id} does not export the required class`);t=new o}else if(e.type==="function"){const i=await w(()=>import(`../plugins/${e.id}/${e.entry||"index.js"}`),[],import.meta.url),o=i.default||i[e.functionName||"init"];if(typeof o!="function")throw new Error(`Plugin ${e.id} does not export the required function`);t={init:o}}else throw new Error(`Unsupported plugin type: ${e.type}`);const n=this.createPluginAPI(e.id);this.plugins.set(e.id,{instance:t,config:e,api:n}),t.init&&await t.init(n),window.core.isDebugMode()&&window.core.logDebug(`Plugin ${e.id} loaded successfully`,"PLUGIN")}catch(t){throw console.error(`Failed to load plugin ${e.id}:`,t),t}}async loadPlugin(e){const t={id:e,type:"class",entry:"index.js"};return this.loadPluginFromConfig(t)}async _loadPluginLegacy(e){if(this.plugins.has(e)){window.core.isDebugMode()&&window.core.logDebug(`Plugin ${e} already loaded`,"PLUGIN");return}try{const t=await w(()=>import(`../plugins/${e}/index.js`),[],import.meta.url),n=t.default||t[e];if(!n)throw new Error(`Plugin ${e} does not export a default class`);const i=new n,o=this.createPluginAPI(e);i.init&&typeof i.init=="function"&&await i.init(o),this.plugins.set(e,{instance:i,api:o,metadata:i.metadata||{}}),window.core.isDebugMode()&&window.core.logDebug(`Plugin ${e} loaded successfully`,"PLUGIN"),this.triggerHook("plugin:loaded",{pluginId:e,plugin:i})}catch(t){throw console.error(`Failed to load plugin ${e}:`,t),t}}async unloadPlugin(e){const t=this.plugins.get(e);if(t)try{t.instance.cleanup&&typeof t.instance.cleanup=="function"&&await t.instance.cleanup(),this.removePluginButtons(e),this.removePluginPages(e),this.removePluginHooks(e),this.plugins.delete(e),window.core.isDebugMode()&&window.core.logDebug(`Plugin ${e} unloaded`,"PLUGIN"),this.triggerHook("plugin:unloaded",{pluginId:e})}catch(n){console.error(`Failed to unload plugin ${e}:`,n)}}createPluginAPI(e){return{addButton:(t,n)=>this.addPluginButton(e,t,n),addPage:(t,n)=>this.addPluginPage(e,t,n),addHook:(t,n)=>this.addHook(t,n,e),getSetting:(t,n)=>this.getPluginSetting(e,t,n),setSetting:(t,n)=>this.setPluginSetting(e,t,n),showToast:window.core.showToast.bind(window.core),showDialog:{confirm:window.DialogManager.showConfirm.bind(window.DialogManager),input:window.DialogManager.showInput.bind(window.DialogManager),popup:window.DialogManager.showPopup.bind(window.DialogManager)}}}addHook(e,t,n){this.hooks.has(e)||this.hooks.set(e,[]),this.hooks.get(e).push({callback:t,pluginId:n}),window.core.isDebugMode()&&window.core.logDebug(`Hook ${e} added by plugin ${n}`,"PLUGIN")}removeHook(e,t,n){if(!this.hooks.has(e))return;const i=this.hooks.get(e),o=i.findIndex(s=>s.callback===t&&s.pluginId===n);o!==-1&&(i.splice(o,1),i.length===0&&this.hooks.delete(e))}async triggerHook(e,t={}){if(!this.hooks.has(e))return;const n=this.hooks.get(e),i=[];for(const o of n)try{const s=await o.callback(t);i.push(s)}catch(s){console.error(`Hook ${e} error in plugin ${o.pluginId}:`,s)}return i}addPluginButton(e,t,n){if(!this.pluginButtons[t]){console.error(`Invalid button location: ${t}`);return}const i={...n,pluginId:e,id:n.id||`plugin-${e}-${Date.now()}`};this.pluginButtons[t].push(i),this.refreshButtons(),window.core.isDebugMode()&&window.core.logDebug(`Button added to ${t} by plugin ${e}`,"PLUGIN")}removePluginButton(e,t,n){if(!this.pluginButtons[t])return;const i=this.pluginButtons[t].findIndex(o=>o.pluginId===e&&o.id===n);i!==-1&&(this.pluginButtons[t].splice(i,1),this.refreshButtons())}removePluginButtons(e){for(const t in this.pluginButtons)this.pluginButtons[t]=this.pluginButtons[t].filter(n=>n.pluginId!==e);this.refreshButtons()}refreshButtons(){const e=document.getElementById("plugin-header-actions");e&&(e.innerHTML="",this.pluginButtons.header.forEach(i=>{const o=this.createButtonElement(i);e.appendChild(o)}));const t=document.getElementById("plugin-sidebar-actions");t&&(t.innerHTML="",this.pluginButtons.sidebar.forEach(i=>{const o=this.createButtonElement(i,"sidebar");t.appendChild(o)}));const n=document.getElementById("plugin-bottom-actions");n&&(n.innerHTML="",this.pluginButtons.bottom.forEach(i=>{const o=this.createButtonElement(i,"bottom");n.appendChild(o)}))}createButtonElement(e,t="header"){const n=document.createElement("button");return n.className=`plugin-${t}-btn`,n.id=e.id,n.title=e.title||"",n.innerHTML=`<span class="material-symbols-rounded">${e.icon}</span>`,e.text&&t==="bottom"&&(n.innerHTML+=`<span class="btn-text">${e.text}</span>`),e.action&&typeof e.action=="function"&&n.addEventListener("click",e.action),n}addPluginPage(e,t,n){const i=`plugin-${e}-${t}`;this.pluginPages.set(i,{...n,pluginId:e,originalId:t}),window.app&&window.app.pagesConfig&&(window.app.pagesConfig[i]={title:n.title,icon:n.icon,file:`plugin-${e}-${t}`,isPlugin:!0,pluginId:e}),window.core.isDebugMode()&&window.core.logDebug(`Page ${i} added by plugin ${e}`,"PLUGIN")}removePluginPage(e,t){const n=`plugin-${e}-${t}`;this.pluginPages.delete(n),window.app&&window.app.pagesConfig&&delete window.app.pagesConfig[n]}removePluginPages(e){const t=[];for(const[n,i]of this.pluginPages)i.pluginId===e&&t.push(n);t.forEach(n=>{this.pluginPages.delete(n),window.app&&window.app.pagesConfig&&delete window.app.pagesConfig[n]})}removePluginHooks(e){for(const[t,n]of this.hooks){const i=n.filter(o=>o.pluginId!==e);i.length===0?this.hooks.delete(t):this.hooks.set(t,i)}}getPluginSetting(e,t,n=null){try{const i=JSON.parse(localStorage.getItem(`plugin_${e}_settings`)||"{}");return i[t]!==void 0?i[t]:n}catch(i){return console.error(`Failed to get plugin setting ${t} for ${e}:`,i),n}}setPluginSetting(e,t,n){try{const i=JSON.parse(localStorage.getItem(`plugin_${e}_settings`)||"{}");i[t]=n,localStorage.setItem(`plugin_${e}_settings`,JSON.stringify(i))}catch(i){console.error(`Failed to set plugin setting ${t} for ${e}:`,i)}}getLoadedPlugins(){return Array.from(this.plugins.keys())}getPluginInfo(e){const t=this.plugins.get(e);return t?{id:e,metadata:t.metadata,loaded:!0}:null}}const I=new v;window.PluginManager=I;const k={home:{title:"nav.home",icon:"home",module:"home",showInNav:!0,order:1},logs:{title:"nav.logs",icon:"description",showInNav:!0,order:2,module:"logs"},settings:{title:"nav.settings",icon:"settings",showInNav:!0,order:3,module:"settings"}},S="home",D={pages:k,defaultPage:S};class B{constructor(){this.currentPage=D.defaultPage||"home",this.pageCache=new Map,this.pagesConfig=D,this.currentPageInstance=null,this.pageActions=[],this.loadedCSS=new Set,this.pluginManager=new v,this.settings={debugMode:!1,useNativeToast:window.core.isKSUEnvironment(),hue:300,language:"zh"},this.init()}async loadCSS(e){return this.loadedCSS.has(e)?Promise.resolve():new Promise((t,n)=>{const i=document.createElement("link");i.rel="stylesheet",i.href=e,i.onload=()=>{this.loadedCSS.add(e),t()},i.onerror=()=>n(new Error(`Failed to load CSS: ${e}`)),document.head.appendChild(i)})}async init(){try{await this.loadSettings(),await window.i18n.init(),this.settings.language&&await window.i18n.setLanguage(this.settings.language),await this.pluginManager.init(),this.generateNavigation(),this.initUI(),await this.pluginManager.triggerHook("app:initialized",{app:this}),await this.loadPage(this.currentPage),document.body.classList.add("app-loaded"),window.core.isDebugMode()&&(window.core.logDebug("App initialized successfully","APP"),window.core.showToast("[DEBUG] App initialized","info"))}catch(e){window.core.showError(e.message,"App initialization failed")}}generateNavigation(){const e=document.querySelector(".nav-content"),t=document.querySelector(".sidebar-nav-items");if(!e||!t)return;e.innerHTML="",t.innerHTML="",Object.entries(this.pagesConfig.pages).filter(([i,o])=>o.showInNav).sort(([i,o],[s,r])=>(o.order||999)-(r.order||999)).forEach(([i,o])=>{const s=document.createElement("a");s.href=`#${i}`,s.className=`nav-item ${i===this.currentPage?"active":""}`,s.dataset.page=i,s.innerHTML=`
        <span class="material-symbols-rounded">${o.icon}</span>
        <span id="nav-${i}"></span>
      `,e.appendChild(s);const r=document.createElement("a");r.href=`#${i}`,r.className=`sidebar-nav-item ${i===this.currentPage?"active":""}`,r.dataset.page=i,r.innerHTML=`
        <span class="material-symbols-rounded">${o.icon}</span>
        <span id="sidebar-nav-${i}"></span>
      `,t.appendChild(r)})}initUI(){this.initNavigation(),this.initSettings(),this.updateUILanguage(),this.applyTheme()}initNavigation(){document.querySelectorAll(".nav-item").forEach(n=>{n.addEventListener("click",i=>{i.preventDefault();const o=n.dataset.page;this.navigateTo(o)})}),document.querySelectorAll(".sidebar-nav-item").forEach(n=>{n.addEventListener("click",i=>{i.preventDefault();const o=n.dataset.page;this.navigateTo(o)})}),window.addEventListener("popstate",n=>{const i=n.state?.page||"home";this.navigateTo(i,!1)})}initSettings(){const e=document.getElementById("settings-btn"),t=document.getElementById("sidebar-settings-btn"),n=document.getElementById("about-btn"),i=document.getElementById("sidebar-about-btn"),o=document.getElementById("settings-dialog"),s=document.getElementById("settings-cancel"),r=document.getElementById("settings-save"),g=()=>{this.loadSettingsUI(),window.DialogManager.showDialogWithAnimation(o)};e?.addEventListener("click",g),t?.addEventListener("click",g);const d=()=>{this.showAboutDialog()};n?.addEventListener("click",d),i?.addEventListener("click",d),s.addEventListener("click",()=>{window.DialogManager.closeDialogWithAnimation(o)}),o.addEventListener("click",u=>{u.target===o&&window.DialogManager.closeDialogWithAnimation(o)}),r.addEventListener("click",async()=>{await this.saveSettings(),window.DialogManager.closeDialogWithAnimation(o),window.core.showToast("设置已保存","success")});const l=document.getElementById("hue-slider"),c=document.getElementById("hue-value");l.addEventListener("input",u=>{const m=u.target.value;c.textContent=m,document.documentElement.style.setProperty("--hue",m)})}async navigateTo(e,t=!0){if(this.currentPage!==e)try{if(this.currentPage==="settings"&&this.currentPageInstance&&this.currentPageInstance.hasChanges){if(!await window.DialogManager.showConfirm(window.i18n.t("settings.unsavedChanges"),window.i18n.t("settings.unsavedMessage")))return;this.currentPageInstance.resetChanges()}this.updateNavigation(e),await this.loadPage(e),t&&history.pushState({page:e},"",`#${e}`),this.currentPage=e,window.core.isDebugMode()&&window.core.logDebug(`Navigated to page: ${e}`,"NAV")}catch(n){window.core.showError(n.message,`Failed to navigate to ${e}`)}}updateNavigation(e){document.querySelectorAll(".nav-item").forEach(i=>{i.classList.toggle("active",i.dataset.page===e)}),document.querySelectorAll(".sidebar-nav-item").forEach(i=>{i.classList.toggle("active",i.dataset.page===e)});const t=this.pagesConfig.pages[e],n=t?window.i18n.t(t.title):window.i18n.t("app.title");document.getElementById("page-title").textContent=n}async loadPage(e){const t=document.getElementById("page-content");await this.pluginManager.triggerHook("page:before-load",{page:e,currentPage:this.currentPage}),this.currentPageInstance&&(t.classList.add("page-transition-exit"),await new Promise(n=>setTimeout(n,100)),this.currentPageInstance.cleanup&&this.currentPageInstance.cleanup(),await this.pluginManager.triggerHook("page:unloaded",{page:this.currentPage,instance:this.currentPageInstance})),t.innerHTML=`
      <div class="loading">
        <span class="material-symbols-rounded">hourglass_empty</span>
        <span style="margin-left: 8px;">${window.i18n.t("app.loading")}</span>
      </div>
    `,t.className="page-loading";try{let n=this.pageCache.get(e);if(n||(n=await this.importPage(e),n&&this.pageCache.set(e,n)),n){const i=this.getPageCSSPath(e);try{await this.loadCSS(i)}catch{window.core.isDebugMode()&&window.core.logDebug(`页面CSS文件不存在: ${i}`,"APP")}const o=await n.render();if(t.innerHTML=o,n.onShow&&await n.onShow(),this.currentPageInstance=n,t.classList.remove("page-loading","page-transition-exit"),t.classList.add("page-transition-enter"),requestAnimationFrame(()=>{t.classList.remove("page-transition-enter"),t.classList.add("page-loaded")}),await this.pluginManager.triggerHook("page:loaded",{page:e,instance:n}),n.getPageActions&&typeof n.getPageActions=="function"){const s=n.getPageActions();this.setPageActions(s)}else this.setPageActions([{icon:"refresh",title:"刷新页面",action:()=>{n.onRefresh&&typeof n.onRefresh=="function"?n.onRefresh():this.loadPage(this.currentPage)}}])}else t.innerHTML=`
          <div class="error-state">
            <span class="material-symbols-rounded">error</span>
            <p>${window.i18n.t("messages.pageNotFound")}</p>
          </div>
        `,this.currentPageInstance=null,this.setPageActions([])}catch(n){this.setPageActions([]),t.innerHTML=`
        <div class="error-state">
          <span class="material-symbols-rounded">error</span>
          <p>${window.i18n.t("messages.pageLoadFailed")}: ${n.message}</p>
        </div>
      `,this.currentPageInstance=null,window.core.isDebugMode()&&window.core.logDebug(`Page load failed: ${n.message}`,"APP")}}async importPage(e){try{const t=this.pagesConfig.pages[e];if(!t)throw new Error(`Page configuration not found for: ${e}`);if(t.isPlugin){const s=this.pluginManager.pluginPages.get(e);if(s&&s.pageClass)return new s.pageClass;throw new Error(`Plugin page class not found for: ${e}`)}const n=t.module||e,o=(await w(()=>import(`./pages/${n}.js`),[],import.meta.url))[this.getPageClassName(e)];return o?new o:null}catch(t){return window.core.isDebugMode()&&window.core.logDebug(`Failed to import page ${e}: ${t.message}`,"APP"),null}}getPageClassName(e){return e.charAt(0).toUpperCase()+e.slice(1)+"Page"}getPageCSSPath(e){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?`/src/assets/css/pages/${e}.css`:`./assets/css/pages/${e}.css`}async loadSettings(){try{const e=localStorage.getItem("modulewebui-settings");e&&(this.settings={...this.settings,...JSON.parse(e)})}catch(e){window.core.isDebugMode()&&window.core.logDebug(`Failed to load settings: ${e.message}`,"SETTINGS")}}async saveSettings(){try{const e=this.settings.language;Object.assign(this.settings,{debugMode:document.getElementById("debug-mode")?.checked||!1,useNativeToast:document.getElementById("native-toast")?.checked||!1,hue:parseInt(document.getElementById("hue-slider")?.value||300),language:document.getElementById("language-select")?.value||"zh"}),e!==this.settings.language&&(await window.i18n.setLanguage(this.settings.language),this.updateUILanguage(),await this.loadPage(this.currentPage)),localStorage.setItem("modulewebui-settings",JSON.stringify(this.settings)),this.applyTheme(),window.core.isDebugMode()&&window.core.logDebug("Settings saved successfully","SETTINGS")}catch(e){window.core.showError(e.message,"Failed to save settings")}}loadSettingsUI(){const e={"debug-mode":{prop:"checked",value:this.settings.debugMode},"native-toast":{prop:"checked",value:this.settings.useNativeToast},"hue-slider":{prop:"value",value:this.settings.hue},"hue-value":{prop:"textContent",value:this.settings.hue},"language-select":{prop:"value",value:this.settings.language}};Object.entries(e).forEach(([t,n])=>{const i=document.getElementById(t);i&&(i[n.prop]=n.value)})}updateUILanguage(){Object.entries(this.pagesConfig.pages).forEach(([t,n])=>{if(n.showInNav){const i=document.getElementById(`nav-${t}`),o=document.getElementById(`sidebar-nav-${t}`),s=window.i18n.t(n.title);i&&(i.textContent=s),o&&(o.textContent=s)}}),Object.entries({"settings-title":"settings.title","setting-language-label":"settings.language","setting-debug-label":"settings.debugMode","setting-debug-desc":"settings.debugModeDesc","setting-toast-label":"settings.nativeToast","setting-toast-desc":"settings.nativeToastDesc","setting-hue-label":"settings.themeHue","settings-cancel":"settings.cancel","settings-save":"settings.save"}).forEach(([t,n])=>{const i=document.getElementById(t);i&&(i.textContent=window.i18n.t(n))})}applyTheme(){document.documentElement.style.setProperty("--hue",this.settings.hue)}getSetting(e){return this.settings[e]}setPageActions(e=[]){this.pageActions=e,this.renderPageActions()}renderPageActions(){const e=document.getElementById("page-actions");e&&(e.innerHTML="",this.pageActions.forEach(n=>{const i=document.createElement("button");i.className="page-action-btn",i.id=n.id||`page-action-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i.title=n.title||"",i.innerHTML=`<span class="material-symbols-rounded">${n.icon}</span>`,n.action&&typeof n.action=="function"&&i.addEventListener("click",n.action),e.appendChild(i)}));const t=document.getElementById("sidebar-page-actions");t&&(t.innerHTML="",this.pageActions.forEach(n=>{const i=document.createElement("button");i.className="sidebar-page-action-btn",i.id=`sidebar-${n.id||`page-action-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}`,i.title=n.title||"",i.innerHTML=`<span class="material-symbols-rounded">${n.icon}</span>`,n.action&&typeof n.action=="function"&&i.addEventListener("click",n.action),t.appendChild(i)})),this.pluginManager.refreshButtons()}showAboutDialog(){this.githubLink="https://github.com/APMMDEVS/ModuleWebUI";const e=`
      <div class="about-content">
        <div class="about-logo">
          <span class="material-symbols-rounded">widgets</span>
        </div>
        <div class="about-text">
          <h3>Module WebUI</h3>
          <p class="version">v2.0.0</p>
          <p class="description">${window.i18n.t("about.description")}</p>
          <div class="about-links">
            <div class="about-link">
              ${window.i18n.t("about.please")}
              <a href="${this.githubLink}" target="_blank">
                ${window.i18n.t("about.github")}
              </a>
              ${window.i18n.t("about.lookoursrc")}
            </div>
          </div>
        </div>
      </div>
    `;window.DialogManager.showPopup({content:e,closable:!0})}}function P(){window.core&&window.i18n&&window.DialogManager?(window.app=new B,window.settingsManager=window.app,window.core.isDebugMode()&&window.core.logDebug("All dependencies loaded, App instance created","APP")):(console.log("Dependencies not loaded, retrying in 10ms..."),setTimeout(P,10))}P();
