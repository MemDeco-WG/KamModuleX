name: Kam Project Initialization
permissions:
  contents: write
  actions: read
  id-token: write
on:
  workflow_dispatch:
    inputs:
      template-url:
        description: "Template download URL (single template: .tar.gz; multiple templates: .zip) - leave empty to skip template import"
        required: false
        type: string
        default: https://github.com/MemDeco-WG/Kam/releases/latest/download/templates.zip
      init-command:
        description: Full initialization command (complete command to run after setup/template import)
        required: false
        type: string
        default: kam init . -t kam_template
      enable-cache:
        description: Toggle version-aware caching for kam and Cargo
        required: false
        type: string
        default: "true"
jobs:
  run-initialization:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup kam
        uses: MemDeco-WG/setup-kam@latest
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          template-url: ${{ github.event.inputs.template-url }}
          enable-cache: ${{ github.event.inputs.enable-cache }}
      - name: Install prerequisites (curl/jq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq
      - name: Install cosign
        run: |
          curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o /tmp/cosign
          sudo install -m 0755 /tmp/cosign /usr/local/bin/cosign
      - name: Fetch OIDC token for Sigstore (SIGSTORE_ID_TOKEN)
        run: |
          if [ -n "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]; then
            TOKEN_JSON=$(curl -sS -X POST "${ACTIONS_ID_TOKEN_REQUEST_URL}" -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}")
            TOKEN=$(echo "$TOKEN_JSON" | jq -r '.value')
            echo "SIGSTORE_ID_TOKEN=$TOKEN" >> $GITHUB_ENV
          fi
      - name: Verify kam installation
        run: kam --version
      - name: Run initialization command
        shell: bash
        run: |
          kam init --help
          echo "Running initialization command: ${{ github.event.inputs.init-command }}"
          ${{ github.event.inputs.init-command }}
          echo "Initialization completed successfully"
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Auto-commit changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: |
            chore: apply config - Template: ${{ github.event.inputs.template-url || 'No template' }} - Command: ${{ github.event.inputs.init-command || github.event.inputs.kam-command }}
          file_pattern: |
            **/*
            !.github/workflows/exec.yml
            !.github/workflows/init.yml
          push_options: --force-with-lease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
