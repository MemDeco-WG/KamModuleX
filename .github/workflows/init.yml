name: Kam Project Initialization

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      template-url:
        description: "Template download URL (single template: .tar.gz; multiple templates: .zip) - leave empty to skip template import"
        required: false
        type: string
        default: "https://github.com/MemDeco-WG/Kam/releases/latest/download/templates.zip"
      init-command:
        description: "Full initialization command (complete command to run after setup/template import)"
        required: false
        type: string
        default: "kam init . -t kam_template -f"
      enable-cache:
        description: "Toggle version-aware caching for kam and Cargo"
        required: false
        type: string
        default: "true"

jobs:
  run-initialization:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kam
        uses: MemDeco-WG/setup-kam@latest
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          template-url: ${{ github.event.inputs.template-url }}
          enable-cache: ${{ github.event.inputs.enable-cache }}

      - name: Verify kam installation
        run: kam --version

      - name: Run initialization command
        shell: bash
        run: |
          kam init --help
          echo "Running initialization command: ${{ github.event.inputs.init-command }}"
          ${{ github.event.inputs.init-command }}
          echo "Initialization completed successfully"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Auto-commit changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: >
            chore: apply config
            - Template: ${{ github.event.inputs.template-url || 'No template' }}
            - Command: ${{ github.event.inputs.init-command || github.event.inputs.kam-command }}
          file_pattern: |
            *
            !.github/workflows/exec.yml
            !.github/workflows/init.yml

          push_options: "--force-with-lease"
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
